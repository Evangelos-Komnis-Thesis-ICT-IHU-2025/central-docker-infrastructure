services:
  nginx:
    image: nginx:1.27-alpine
    container_name: scorm-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - jenkins
      - kibana
      - minio
    networks:
      - scorm-network

  jenkins:
    build:
      context: ./jenkins
      dockerfile: Dockerfile
    image: scorm/jenkins:lts
    container_name: scorm-jenkins
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      # Keep setup wizard enabled for first boot in dev
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=true
    volumes:
      - jenkins_home:/var/jenkins_home
      # Required for Docker-in-Docker style builds from Jenkins jobs
      - /var/run/docker.sock:/var/run/docker.sock
    group_add:
      # Set DOCKER_GID to host docker group id (e.g. 998)
      - "${DOCKER_GID}"
    networks:
      - scorm-network

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION}
    container_name: scorm-elasticsearch
    restart: unless-stopped
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    networks:
      - scorm-network

  kibana:
    image: docker.elastic.co/kibana/kibana:${ELASTIC_VERSION}
    container_name: scorm-kibana
    restart: unless-stopped
    ports:
      - "5601:5601"
    environment:
      - ELASTICSEARCH_HOSTS=http://elasticsearch:9200
      - SERVER_PUBLICBASEURL=http://localhost:5601
    depends_on:
      - elasticsearch
    networks:
      - scorm-network

  minio:
    image: minio/minio:RELEASE.2025-10-15T17-29-55Z
    container_name: scorm-minio
    restart: unless-stopped
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
    volumes:
      - minio_data:/data
    networks:
      - scorm-network

  # -------------------------------------------------------------------------
  # Future Backend Service (Java 21 - Spring Boot)
  # Service Name: scorm-engine
  # -------------------------------------------------------------------------
  # scorm-engine:
  #   image: ghcr.io/scorm-engine/scorm-engine:latest
  #   container_name: scorm-engine
  #   restart: unless-stopped
  #   env_file:
  #     - ./.env
  #   environment:
  #     - SPRING_PROFILES_ACTIVE=production
  #     - JAVA_OPTS=-Xms512m -Xmx1024m
  #     - ELASTICSEARCH_URL=http://elasticsearch:9200
  #     - MINIO_ENDPOINT=http://minio:9000
  #     - MINIO_BUCKET=scorm-packages
  #   ports:
  #     - "8081:8080"
  #   depends_on:
  #     - elasticsearch
  #     - minio
  #   networks:
  #     - scorm-network

  # -------------------------------------------------------------------------
  # Future SCORM Player Service (Node.js 20)
  # Service Name: scorm-engine-player
  # -------------------------------------------------------------------------
  # scorm-engine-player:
  #   image: ghcr.io/scorm-engine/scorm-engine-player:latest
  #   container_name: scorm-engine-player
  #   restart: unless-stopped
  #   env_file:
  #     - ./.env
  #   environment:
  #     - NODE_ENV=production
  #     - BACKEND_API_URL=http://scorm-engine-backend:8080
  #   ports:
  #     - "3000:3000"
  #   depends_on:
  #     - scorm-engine-backend
  #   networks:
  #     - scorm-network

volumes:
  jenkins_home:
    name: scorm_jenkins_home
  elasticsearch_data:
    name: scorm_elasticsearch_data
  minio_data:
    name: scorm_minio_data

networks:
  scorm-network:
    external: true
    name: scorm-network
