name: Release

on:
  workflow_dispatch:
  push:
    branches:
      - master

permissions:
  contents: write

concurrency:
  group: infrastructure-release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git identity
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Resolve release tag
        id: tag
        run: |
          set -euo pipefail
          git fetch --force --tags

          EXISTING_TAG="$(git tag --points-at "$GITHUB_SHA" --list 'v*' | head -n1 || true)"
          if [ -n "$EXISTING_TAG" ]; then
            echo "Found existing tag on HEAD: $EXISTING_TAG"
            echo "release_tag=$EXISTING_TAG" >> "$GITHUB_OUTPUT"
            echo "created_tag=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          LAST_TAG="$(git tag --list 'v*' --sort=-v:refname | head -n1 || true)"
          if [ -z "$LAST_TAG" ]; then
            LAST_TAG="v0.0.0"
          fi

          if ! [[ "$LAST_TAG" =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "Latest tag '$LAST_TAG' is not valid semver (vMAJOR.MINOR.PATCH)."
            exit 1
          fi

          MAJOR="${BASH_REMATCH[1]}"
          MINOR="${BASH_REMATCH[2]}"
          PATCH="${BASH_REMATCH[3]}"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_TAG="v${MAJOR}.${MINOR}.${NEXT_PATCH}"

          echo "Next release tag: $NEXT_TAG"
          git tag -a "$NEXT_TAG" -m "Release $NEXT_TAG"
          git push origin "$NEXT_TAG"

          echo "release_tag=$NEXT_TAG" >> "$GITHUB_OUTPUT"
          echo "created_tag=true" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.release_tag }}"

          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists. Skipping creation."
            exit 0
          fi

          gh release create "$TAG" \
            --verify-tag \
            --title "$TAG" \
            --generate-notes
